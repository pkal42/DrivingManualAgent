{
  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
  "contentVersion": "1.0.0.0",
  "metadata": {
    "_generator": {
      "name": "bicep",
      "version": "0.39.26.7824",
      "templateHash": "10476800159225295222"
    }
  },
  "parameters": {
    "searchServiceName": {
      "type": "string",
      "metadata": {
        "description": "Name of the Azure AI Search service where data source will be created"
      }
    },
    "storageAccountName": {
      "type": "string",
      "metadata": {
        "description": "Name of the storage account containing PDF documents"
      }
    },
    "containerName": {
      "type": "string",
      "defaultValue": "pdfs",
      "metadata": {
        "description": "Name of the blob container with PDF files"
      }
    },
    "dataSourceName": {
      "type": "string",
      "defaultValue": "driving-manual-datasource",
      "metadata": {
        "description": "Name for the data source resource"
      }
    },
    "enableChangeDetection": {
      "type": "bool",
      "defaultValue": true,
      "metadata": {
        "description": "Enable change detection for incremental indexing"
      }
    },
    "enableSoftDelete": {
      "type": "bool",
      "defaultValue": true,
      "metadata": {
        "description": "Enable soft delete detection for automatic removal from index"
      }
    },
    "softDeleteColumnName": {
      "type": "string",
      "defaultValue": "isDeleted",
      "metadata": {
        "description": "Metadata field name for soft delete flag (e.g., \"isDeleted\")"
      }
    },
    "softDeleteMarkerValue": {
      "type": "string",
      "defaultValue": "true",
      "metadata": {
        "description": "Value indicating soft delete (e.g., \"true\")"
      }
    }
  },
  "variables": {
    "storageConnectionString": "[format('ResourceId=/subscriptions/{0}/resourceGroups/{1}/providers/Microsoft.Storage/storageAccounts/{2};', subscription().subscriptionId, resourceGroup().name, parameters('storageAccountName'))]"
  },
  "resources": [
    {
      "type": "Microsoft.Search/searchServices/dataSources",
      "apiVersion": "2024-06-01-preview",
      "name": "[format('{0}/{1}', parameters('searchServiceName'), parameters('dataSourceName'))]",
      "identity": {
        "type": "SystemAssigned"
      },
      "properties": {
        "type": "azureblob",
        "description": "Data source for PDF driving manuals in blob storage with managed identity authentication",
        "credentials": {
          "connectionString": "[variables('storageConnectionString')]"
        },
        "container": {
          "name": "[parameters('containerName')]",
          "query": ""
        },
        "dataChangeDetectionPolicy": "[if(parameters('enableChangeDetection'), createObject('@odata.type', '#Microsoft.Azure.Search.HighWaterMarkChangeDetectionPolicy', 'highWaterMarkColumnName', 'metadata_storage_last_modified'), null())]",
        "dataDeletionDetectionPolicy": "[if(parameters('enableSoftDelete'), createObject('@odata.type', '#Microsoft.Azure.Search.SoftDeleteColumnDeletionDetectionPolicy', 'softDeleteColumnName', parameters('softDeleteColumnName'), 'softDeleteMarkerValue', parameters('softDeleteMarkerValue')), null())]"
      }
    }
  ],
  "outputs": {
    "dataSourceId": {
      "type": "string",
      "metadata": {
        "description": "Resource ID of the created data source"
      },
      "value": "[resourceId('Microsoft.Search/searchServices/dataSources', parameters('searchServiceName'), parameters('dataSourceName'))]"
    },
    "dataSourceName": {
      "type": "string",
      "metadata": {
        "description": "Name of the created data source"
      },
      "value": "[parameters('dataSourceName')]"
    },
    "connectionType": {
      "type": "string",
      "metadata": {
        "description": "Connection type used for data source authentication"
      },
      "value": "ManagedIdentity"
    }
  }
}