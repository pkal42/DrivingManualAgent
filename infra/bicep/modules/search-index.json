{
  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
  "contentVersion": "1.0.0.0",
  "metadata": {
    "_generator": {
      "name": "bicep",
      "version": "0.39.26.7824",
      "templateHash": "16364857837079740707"
    }
  },
  "parameters": {
    "searchServiceName": {
      "type": "string",
      "metadata": {
        "description": "Name of the Azure AI Search service where index will be created"
      }
    },
    "indexName": {
      "type": "string",
      "defaultValue": "driving-manual-index",
      "metadata": {
        "description": "Name for the search index resource"
      }
    },
    "vectorDimensions": {
      "type": "int",
      "defaultValue": 3072,
      "metadata": {
        "description": "Dimensions for vector embeddings (text-embedding-3-large = 3072)"
      }
    },
    "enableSemanticSearch": {
      "type": "bool",
      "defaultValue": true,
      "metadata": {
        "description": "Enable semantic search configuration for AI-powered reranking"
      }
    }
  },
  "resources": [
    {
      "type": "Microsoft.Search/searchServices/indexes",
      "apiVersion": "2024-06-01-preview",
      "name": "[format('{0}/{1}', parameters('searchServiceName'), parameters('indexName'))]",
      "properties": {
        "fields": [
          {
            "name": "chunk_id",
            "type": "Edm.String",
            "key": true,
            "searchable": false,
            "filterable": true,
            "sortable": false,
            "facetable": false,
            "retrievable": true
          },
          {
            "name": "content",
            "type": "Edm.String",
            "searchable": true,
            "filterable": false,
            "sortable": false,
            "facetable": false,
            "retrievable": true,
            "analyzer": "standard.lucene"
          },
          {
            "name": "chunk_vector",
            "type": "Collection(Edm.Single)",
            "searchable": true,
            "filterable": false,
            "sortable": false,
            "facetable": false,
            "retrievable": false,
            "vectorSearchDimensions": "[parameters('vectorDimensions')]",
            "vectorSearchProfileName": "default-vector-profile"
          },
          {
            "name": "document_id",
            "type": "Edm.String",
            "searchable": true,
            "filterable": true,
            "sortable": true,
            "facetable": true,
            "retrievable": true
          },
          {
            "name": "state",
            "type": "Edm.String",
            "searchable": false,
            "filterable": true,
            "sortable": true,
            "facetable": true,
            "retrievable": true
          },
          {
            "name": "page_number",
            "type": "Edm.Int32",
            "searchable": false,
            "filterable": true,
            "sortable": true,
            "facetable": false,
            "retrievable": true
          },
          {
            "name": "has_related_images",
            "type": "Edm.Boolean",
            "searchable": false,
            "filterable": true,
            "sortable": false,
            "facetable": true,
            "retrievable": true
          },
          {
            "name": "image_blob_urls",
            "type": "Collection(Edm.String)",
            "searchable": false,
            "filterable": false,
            "sortable": false,
            "facetable": false,
            "retrievable": true
          },
          {
            "name": "image_descriptions",
            "type": "Collection(Edm.String)",
            "searchable": true,
            "filterable": false,
            "sortable": false,
            "facetable": false,
            "retrievable": true
          },
          {
            "name": "metadata_storage_name",
            "type": "Edm.String",
            "searchable": true,
            "filterable": true,
            "sortable": true,
            "facetable": false,
            "retrievable": true
          }
        ],
        "vectorSearch": {
          "algorithms": [
            {
              "name": "hnsw-config",
              "kind": "hnsw",
              "hnswParameters": {
                "m": 4,
                "efConstruction": 400,
                "metric": "cosine"
              }
            }
          ],
          "profiles": [
            {
              "name": "default-vector-profile",
              "algorithm": "hnsw-config"
            }
          ]
        },
        "semantic": "[if(parameters('enableSemanticSearch'), createObject('configurations', createArray(createObject('name', 'default-semantic-config', 'prioritizedFields', createObject('titleField', createObject('fieldName', 'document_id'), 'contentFields', createArray(createObject('fieldName', 'content')), 'keywordsFields', createArray(createObject('fieldName', 'state'), createObject('fieldName', 'metadata_storage_name')))))), null())]"
      }
    }
  ],
  "outputs": {
    "indexId": {
      "type": "string",
      "metadata": {
        "description": "Resource ID of the created search index"
      },
      "value": "[resourceId('Microsoft.Search/searchServices/indexes', parameters('searchServiceName'), parameters('indexName'))]"
    },
    "indexName": {
      "type": "string",
      "metadata": {
        "description": "Name of the created search index"
      },
      "value": "[parameters('indexName')]"
    }
  }
}